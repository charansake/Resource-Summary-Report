<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>OFSC Resource Analytics — Automated</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg1: #eef2f7;
  --bg2: #d9e3f5;
  --card: #ffffff;
  --primary: #0b66ff;
  --muted: #65748b;
  --shadow: 0 4px 14px rgba(11,102,255,0.08);
}

html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, "Segoe UI", system-ui;
  background: transparent;
  color: #0f172a;
  -webkit-font-smoothing: antialiased;
  overflow-y: scroll;
}

.bg-slideshow {
  position: fixed;
  top: 0; 
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}

.bg-slide {
  position: absolute;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0;
  transition: opacity 2.5s ease-in-out;
}

.bg-slide.active {
  opacity: 1;
}

.wrap {
  max-width: 840px;
  margin: 24px auto;
  padding: 20px;
  background: var(--card);
  border-radius: 16px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(6px);
  transition: opacity 0.6s ease;
  position: relative;
}

.wrap.fade-out {
  opacity: 0;
  pointer-events: none;
}

.card {
  background: transparent;
  border-radius: 16px;
  padding: 16px;
}

.invoice-header-logo {
  width: 150px;
  display: flex;
  justify-content: flex-start;
  align-items: center;
}
.invoice-header-logo img {
  max-width: 100%;
  height: auto;
}

h1 {
  font-size: 24px;
  margin: 8px 0 20px 0;
  font-weight: 700;
  text-align: center;
  color: #0b66ff;
}

input[type="text"], input[type="date"] {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #d8e2f2;
  background: #f8fbff;
  font-size: 15px;
  margin-top: 6px;
}
input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 6px rgba(11,102,255,0.15);
}

.btn {
  background: var(--primary);
  color: #fff;
  padding: 10px 20px;
  border-radius: 6px;
  border: none;
  font-size: 15px;
  cursor: pointer;
  font-weight: 600;
  display: block;
  margin: 20px auto;
  min-width: 180px;
  transition: 0.25s;
  position: relative;
}
.btn:hover:not(:disabled) { background-color: #084ed6; }
.btn:disabled { opacity: 0.7; cursor: not-allowed; }
.btn-print { background: #334155 !important; }

/* Spinner inside button */
.btn.loading {
  pointer-events: none;
  opacity: 0.8;
}
.btn.loading::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 18px;
  height: 18px;
  margin: -9px 0 0 -9px;
  border: 2px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#alertBox {
  display: none;
  padding: 10px;
  margin-top: 8px;
  border-radius: 10px;
  background: #fff1f1;
  color: #b91c1c;
  text-align: center;
  font-size: 14px;
}

.kpis {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 20px;
}
.kpi {
  flex: 1 1 30%;
  max-width: 180px;
  background: #f8fbff;
  border: 1px solid #e8f1ff;
  border-radius: 12px;
  text-align: center;
  padding: 12px;
}
.kpi .num {
  font-weight: 800;
  font-size: 18px;
}
.kpi .lbl {
  font-size: 12px;
  color: var(--muted);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
thead th {
  background: #f1f6ff;
  padding: 10px;
  text-align: left;
  font-size: 13px;
}
tbody td {
  padding: 10px;
  border-bottom: 1px solid #eef3fb;
}

.badge { padding: 2px 6px; font-size: 12px; border-radius: 6px; color: #fff; }
.badge.missed { background:#ef4444; }
.badge.overdue { background:#f59e0b; }
.badge.progressed { background:#0ea5e9; }

#chartContainer {
  margin-top: 20px;
  max-height: 260px;
  display:flex;
  justify-content:center;
  position:relative;
}
#chartCenterText {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:#0f172a;
  font-weight:700;
  text-align:center;
}

#pdfHeader {
  display:flex;
  align-items:center;
  gap:20px;
  margin-bottom:20px;
}

@media (max-width:600px){
  .kpi{flex:1 1 100%;}
  #pdfHeader{flex-direction:column;text-align:center;}
}

@media print {
  body * { visibility: hidden; }
  #reportCard, #reportCard * { visibility: visible; }
  #reportCard { position:absolute; top:0; left:0; width:100%; }
  #printBtn { display:none; }
}

/* Loader styles */
#loader {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(255,255,255,0.85);
  z-index:9999;

  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:20px;
  font-weight:600;
  color:#0b66ff;
}
#loader .spinner {
  border:4px solid #f3f3f3;
  border-top:4px solid #0b66ff;
  border-radius:50%;
  width:40px; height:40px;
  animation:spin 1s linear infinite;
}
</style>
</head>

<body>

<div class="bg-slideshow">
    <div class="bg-slide" style="background-image:url('bg1.jpg');"></div>
    <div class="bg-slide" style="background-image:url('bg2.jpg');"></div>
    <div class="bg-slide" style="background-image:url('bg3.jpg');"></div>
    <div class="bg-slide" style="background-image:url('bg4.jpg');"></div>
</div>

<!-- Loader -->
<div id="loader">
  <div class="spinner"></div>
  <div style="margin-top:12px;">Generating, Please Wait...</div>
</div>

<div class="wrap">

  <div class="container-fluid px-0 mb-3">
    <div class="row align-items-center">
        <div class="col-3 d-flex align-items-center">
            <img src="logo.png" alt="Company Logo" class="img-fluid" style="max-height: 55px;">
        </div>

        <div class="col-6 text-center">
            <h1 class="fw-bold text-primary m-0" style="font-size: 28px;">Resource Summary Report</h1>
        </div>

        <div class="col-3"></div>
    </div>
  </div>

    <label>Resource ID</label>
    <input id="resourceIdInput" type="text" placeholder="e.g. 55015" />

    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
      <div style="flex:1; min-width:120px;">
        <label>From</label>
        <input id="fromDate" type="date" />
      </div>
      <div style="flex:1; min-width:120px;">
        <label>To</label>
        <input id="toDate" type="date" />
      </div>
    </div>

    <button id="reportBtn" class="btn">Generate Report</button>
    <div id="alertBox"></div>
    <div class="small-hint" style="text-align:center;color:var(--muted);margin-top:6px;">Report will generate after clicking the button.</div>
</div>

<div class="card" id="reportCard" style="display:none;">

    <div id="pdfHeader">
      <div class="invoice-header-logo">
        <img src="logo.png" alt="Company Logo">
      </div>
      <h2 style="margin:0;">Resource Summary Report</h2>
    </div>

    <!-- Resource Info + Dates -->
    <div class="resourceInfo" style="display:flex; justify-content:center; gap:20px; padding:14px; background:#f2f6ff; border-radius:14px; flex-wrap:wrap;">
      <div class="resourceDetails">
        <div><b>Name:</b> <span id="resName">-</span></div>
        <div><b>ID:</b> <span id="resId">-</span></div>
      </div>
      <div class="dateDetails">
        <div><b>From:</b> <span id="resFromDate">-</span></div>
        <div><b>To:</b> <span id="resToDate">-</span></div>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="num" id="statTotal">0</div><div class="lbl">Total Jobs</div></div>
      <div class="kpi"><div class="num" id="statProgressed">0</div><div class="lbl">Completed</div></div>
      <div class="kpi"><div class="num" id="statMissed">0</div><div class="lbl">Missed</div></div>
      <div class="kpi"><div class="num" id="statOvertime">0h 0m</div><div class="lbl">Overtime</div></div>
      <div class="kpi"><div class="num" id="statTotalHours">0h 0m</div><div class="lbl">Planned Hours</div></div>
      <div class="kpi"><div class="num" id="statWorkedHours">0h 0m</div><div class="lbl">Worked Hours</div></div>
      <div class="kpi"><div class="num" id="statBalanceHours">0h 0m</div><div class="lbl">Balance Hours</div></div>
    </div>

    <table>
      <thead>
        <tr><th>Activity ID</th><th>Status</th><th>Planned</th><th>Worked</th><th>Extra</th></tr>
      </thead>
      <tbody id="jobsBody"></tbody>
    </table>

    <div id="chartContainer">
      <canvas id="chartCanvas"></canvas>
      <div id="chartCenterText"></div>
    </div>

    <button id="printBtn" class="btn btn-print">Print Report</button>

    <div style="text-align:center; margin-top:20px; font-size:12px; color:#65748b;">
      Designed by Sake Charan Teja
    </div>

</div>

<script>
let slides = document.querySelectorAll(".bg-slide");
let currentSlide = 0;
function cycleSlides() {
  slides.forEach((s, i) => s.classList.toggle("active", i === currentSlide));
  currentSlide = (currentSlide + 1) % slides.length;
}
cycleSlides();
setInterval(cycleSlides, 6000);

let AccessToken = null;
let chartInstance = null;

const reportBtn = document.getElementById("reportBtn");
const printBtn = document.getElementById("printBtn");
const resourceIdInput = document.getElementById("resourceIdInput");
const fromDate = document.getElementById("fromDate");
const toDate = document.getElementById("toDate");
const alertBox = document.getElementById("alertBox");
const reportCard = document.getElementById("reportCard");
const jobsBody = document.getElementById("jobsBody");

const statTotal = document.getElementById("statTotal");
const statProgressed = document.getElementById("statProgressed");
const statMissed = document.getElementById("statMissed");
const statOvertime = document.getElementById("statOvertime");
const statTotalHours = document.getElementById("statTotalHours");
const statWorkedHours = document.getElementById("statWorkedHours");
const statBalanceHours = document.getElementById("statBalanceHours");

const chartCenterText = document.getElementById("chartCenterText");
const resNameElem = document.getElementById("resName");
const resIdElem = document.getElementById("resId");
const loader = document.getElementById("loader");
const resFromDateElem = document.getElementById("resFromDate");
const resToDateElem = document.getElementById("resToDate");

function showAlert(msg, visible=true){ alertBox.textContent = msg; alertBox.style.display = visible ? "block" : "none"; }
function showLoader(show){ loader.style.display = show ? "flex" : "none"; }

function formatHoursExact(mins){
  if(isNaN(mins) || mins===null) return "0h 0m";
  mins = Math.round(mins);
  const h = Math.floor(mins/60);
  const m = mins % 60;
  return `${h}h ${m}m`;
}

function destroyChart(){ if(chartInstance) chartInstance.destroy(); }

function drawChart(worked, balance){
  destroyChart();
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  chartCenterText.innerHTML = `Worked: ${formatHoursExact(worked)}<br>Balance: ${formatHoursExact(balance>0?balance:0)}`;
  chartInstance = new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["Worked","Balance"],
      datasets:[{
        data:[worked, balance>0?balance:0],
        backgroundColor:["#16a34a","#facc15"],
        borderColor:"#fff",
        borderWidth:2
      }]
    },
    options:{ cutout:"70%", plugins:{ legend:{ display:true, position:"bottom" } } }
  });
}

function sendPF(data){ window.parent.postMessage(data,"*"); }
function requestAccessToken(){ sendPF({ apiVersion:1, method:"callProcedure", callId:"token_"+Date.now(), procedure:"getAccessToken", params:{ applicationKey:"sakecharanteja" }}); }

function onPFMessage(ev){
  let data;
  try{ data = typeof ev.data==="string"?JSON.parse(ev.data):ev.data; }catch{ return; }
  if(!data || !data.method) return;
  if(data.method==="init") sendPF({apiVersion:1,method:"initEnd"});
  if(data.method==="callProcedureResult" && data.procedure==="getAccessToken" && data.resultData?.token){
      AccessToken = data.resultData.token;
      generateReportInternal();
  }
}

function initPlugin(){ window.addEventListener("message", onPFMessage, false); sendPF({apiVersion:1,method:"ready",sendInitData:true}); }

async function generateReportInternal(){
  const id = resourceIdInput.value.trim();
  const from = fromDate.value;
  const to = toDate.value;
  if(!id || !from || !to){ showAlert("⚠️ Please complete all fields."); reportBtn.disabled=false; reportBtn.classList.remove("loading"); showLoader(false); return; }

  showAlert("Processing report...");
  showLoader(true);

  try{
    let resName = "N/A";
    try{ const r = await apiGet(`/rest/ofscCore/v1/resources/${encodeURIComponent(id)}`); resName = r.name || "N/A"; }catch{}
    resNameElem.textContent = resName;
    resIdElem.textContent = id;
    resFromDateElem.textContent = from;
    resToDateElem.textContent = to;

    const q = `/rest/ofscCore/v1/activities?resources=${encodeURIComponent(id)}&dateFrom=${from}&dateTo=${to}&fields=activityId,status,startTime,endTime,deliveryWindowStart,deliveryWindowEnd`;
    const acts = await apiGet(q);
    const activities = acts.items || [];

    if(!activities.length){ showAlert("No activities for selected dates."); showLoader(false); return; }

    let totalPlanned=0, totalWorked=0, countMissed=0, countProgressed=0, totalExtra=0;
    jobsBody.innerHTML = "";

    activities.forEach(a=>{
      const plannedMins = (a.deliveryWindowStart && a.deliveryWindowEnd) ? (new Date(`1970-01-01T${a.deliveryWindowEnd}`) - new Date(`1970-01-01T${a.deliveryWindowStart}`))/60000 : 0;
      const workedMins = (a.startTime && a.endTime) ? (new Date(a.endTime)-new Date(a.startTime))/60000 : 0;

      totalPlanned += plannedMins;
      totalWorked += workedMins;

      let extraMins = 0;
      if(workedMins > plannedMins) extraMins = workedMins - plannedMins;
      totalExtra += extraMins;

      if(a.status==="Missed") countMissed++;
      if(a.status==="Progressed") countProgressed++;

      let badgeClass = "progressed";
      if(a.status==="Missed") badgeClass="missed";
      else if(extraMins>0) badgeClass="overdue";

      jobsBody.innerHTML += `<tr>
        <td>${a.activityId}</td>
        <td><span class="badge ${badgeClass}">${a.status}</span></td>
        <td>${formatHoursExact(plannedMins)}</td>
        <td>${formatHoursExact(workedMins)}</td>
        <td>${extraMins>0?formatHoursExact(extraMins):"-"}</td>
      </tr>`;
    });

    statTotal.textContent = activities.length;
    statProgressed.textContent = countProgressed;
    statMissed.textContent = countMissed;
    statOvertime.textContent = formatHoursExact(totalExtra);
    statTotalHours.textContent = formatHoursExact(totalPlanned);
    statWorkedHours.textContent = formatHoursExact(totalWorked);
    statBalanceHours.textContent = formatHoursExact(totalPlanned-totalWorked>0?totalPlanned-totalWorked:0);

    drawChart(totalWorked,totalPlanned-totalWorked);
    reportCard.style.display="block";
    showAlert("✅ Report generated successfully!", true);

  }catch(err){
    console.error(err);
    showAlert("❌ Error generating report.");
  }finally{
    reportBtn.disabled=false;
    reportBtn.classList.remove("loading");
    showLoader(false);
  }
}

function apiGet(url){ return fetch(url, { headers:{ Authorization:AccessToken?`Bearer ${AccessToken}`:"" } }).then(r=>r.json()); }

reportBtn.addEventListener("click", ()=>{
  const id = resourceIdInput.value.trim();
  const from = fromDate.value;
  const to = toDate.value;
  if(!id || !from || !to){ showAlert("⚠️ Please fill all mandatory fields."); return; }
  reportBtn.disabled=true;
  reportBtn.classList.add("loading");
  showAlert("⏳ Generating report...");
  showLoader(true);
  if(!AccessToken) requestAccessToken(); else generateReportInternal();
});

printBtn.addEventListener("click", ()=>window.print());

initPlugin();
</script>

</body>
</html>
